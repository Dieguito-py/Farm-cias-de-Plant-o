<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlantOn</title>

    <!-- CSS do Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    
    <!-- CSS do Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

    <style>
        body, html {
            height: 100%;
            margin: 0;
            background-color: #000;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Bibliotecas JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <script>
        var map = L.map('map').setView([-23.5505, -46.6333], 13); // Posição inicial: São Paulo

        // Modo Dark do mapa
        L.tileLayer('https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            // Attribution opcional
            // attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(map);

        var rota;  // Variável para armazenar a rota

        // Função para pegar a localização do usuário e criar a rota
        function obterLocalizacao() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var latitude = position.coords.latitude;
                    var longitude = position.coords.longitude;

                    // Ajusta o mapa para a localização do usuário
                    map.setView(new L.LatLng(latitude, longitude), 13);

                    // Adiciona um marcador na localização do usuário
                    L.marker([latitude, longitude]).addTo(map)
                        .bindPopup("Você está aqui!")
                        .openPopup();

                    // Cria a rota inicial para a localização do usuário (sem destino ainda)
                    rota = L.Routing.control({
                        waypoints: [
                            L.latLng(latitude, longitude), // Localização atual do usuário
                        ],
                        routeWhileDragging: true, // Atualiza a rota enquanto o usuário arrasta o ponto de destino
                        createMarker: function() { return null; }, // Não cria marcador nos pontos
                        lineOptions: {
                            styles: [{ color: 'blue', weight: 5 }] // Estilo da linha
                        }
                    }).addTo(map);

                }, function(error) {
                    alert("Erro ao obter a localização: " + error.message);
                });
            } else {
                alert("Geolocalização não é suportada neste navegador.");
            }
        }

        // Função para atualizar a rota com o novo destino ao clicar no mapa
        function atualizarRota(destinoLatLng) {
            if (rota) {
                // Atualiza os pontos da rota: ponto de partida (usuário) e novo destino
                rota.setWaypoints([
                    rota.getWaypoints()[0], // Mantém o ponto de partida (localização do usuário)
                    destinoLatLng // Atualiza o destino
                ]);
            }
        }

        // Evento de clique no mapa para definir o destino da rota
        map.on('click', function(event) {
            var destinoLatLng = event.latlng;  // Pega as coordenadas do clique

            // Atualiza a rota com o novo destino
            atualizarRota(destinoLatLng);

            // Adiciona um marcador no destino clicado
            L.marker(destinoLatLng).addTo(map)
                .bindPopup("Destino")
                .openPopup();
        });

        // Chama a função ao carregar a página para pegar a localização
        obterLocalizacao();
    </script>
</body>
</html>